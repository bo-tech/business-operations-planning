* Sprint 3: Kubernetes Layer Extraction Experiment

Started: 2026-02-14

** Plan

- [X] Refine plan according to phases in the ~b-ops~ repository.
- [ ] Research how others handle shared Kustomize bases across repos (Flux
  multi-source, OCI, remote URLs)
- [ ] Deployment of the bootstrap folder
  - Deployment of Manifests
  - Deployment of cluster specific secrets
- [ ] Deployment of cluster specific settings / secret settings
- [ ] Push the repository into the internal Gitea service
- [ ] Kick off Flux, focus on cluster ~dev-env~
- [ ] --- refine below this point
- [ ] Experiment: explore multi-repo approaches for Flux/Kustomize layer
- [ ] Experiment: try out most promising approaches with VolSync
  templates
- [ ] Experiment: explore Taskfile pattern for cluster tasks (push to
  internal Gitea)
- [ ] Document findings and decide on the approach

** Focus

Discover how to split the Kubernetes layer out of ~b-ops~ into
~business-operations~.

The details of the phases are documented in ~b-ops~ within the file
~docs/kubernetes/bootstrap-overview.rst~.

** Checkpoint

** Notes

*** Overview ~b-ops~

Looking at the following "phases" as described in the ~b-ops~ bootstrap overview:

- *Base infrastructure*
  - This is covered already from sprint 2.
- *Bootstrap*
  - This is about making FluxCD operational and providing a Git server so that
    FluxCD can start to take over.
  - Could aim for an empty cluster modeled after the ~dev-env~ setup.
  - Allows to "git push" into the cluster, and Flux will reconcile.
- *Base Apps*
  - Groups together the applications which are required so
    that the cluster is fully able to manage itself.
  - Examples: Vault, External Secrets, Gitlab, Volsync, Flux Webhook, Snapshot
    Controller, DNS, Rook-Ceph
- *Apps*
  - Everything else.

The current setup is already layered.

Only the layer *Apps* is expected to be customized.

*Base Apps* is still somewhat unclear, esp. since it does have "heavy" content
like Gitlab, Rook-Ceph and Vault.

Ideally the layered concept can stay to some degree.

The *Apps* part should eventually be split in some way, so that it is possible
to decide which apps to install. It should be possible to also bring one's own
apps without a need to be clued into the mono repository on the long run.

*** Bootstrap phase

**** Pre-conditions

- Cluster is working and can be accessed via ~kubectl~.

**** Steps

- Deploy ~bootstrap~ folder via ~kustomize~.
- Deploy the cluster's age key.
- Deploy Gitea bootstrap secret.
- Wait until Gitea has deen initialized and configured.
- Push repository into Gitea.
- Deploy cluster settings and secret settings.
- Kick off Flux by deploying ~flux/config~ via ~kustomize~.

Note: ~kustomize~ means ~kubectl apply --server-side --kustomize~.

*** Base apps phase

This is already purely done via Flux.

** Learnings and Insights

** Closing Status
