* Sprint 2: Testing Foundation for demo-ops

Started: 2026-02-08

** Plan

- [X] Prepare a suitable test host (Linux, KVM)
- [X] Boot ~demo-ops~ dev config in QEMU on the test host, verify SSH works manually
  - [X] Build custom NixOS installer ISO with SSH key
  - [X] Transfer ISO to test host
  - [X] Boot QEMU VM on ~br0~, verify installer gets DHCP address
  - [X] Adjust ~dev.nix~ to static IP (10.10.10.210), add serial console
  - [X] Run ~nixos-anywhere~ to deploy ~demo-ops#dev~ into the VM
  - [X] Verify SSH to deployed system works
  - [X] Run full ansible flow (re-create-machines + bootstrap)
  - [X] Verify k0s cluster operational (kubectl shows pods)
- [ ] Review nixos testing, it seems to provide 80% of what is needed
- [ ] Review existing infrastructure testing tooling (testinfra, labgrid, goss, etc.)
- [ ] Decide where the test code lives (~demo-ops~, separate repo, or ~business-operations~)
- [ ] Set up pytest project skeleton with nix devShell
- [ ] Write QEMU VM lifecycle wrapper (start, wait for SSH, stop)
- [ ] Write first pytest test: boot VM, assert SSH connection works
- [ ] Build NixOS installer ISO with test SSH key baked in
- [ ] Run recreate-machines playbook from pytest against the VM
- [ ] Run bootstrap playbook, assert k0s node is Ready and Cilium is running
- [ ] Document how to trigger test runs from the workstation (SSH to test host)
- [ ] Improve key generation handling in ~demo-ops~ (pulled from backlog)

** Focus

Prove the end-to-end deployment pipeline can be tested automatically
against a QEMU VM.

** Checkpoint

"Can I run a command that deploys ~demo-ops~ into a VM and verifies
Kubernetes is running?"

** Notes

*** QEMU bridge helper for regular users

QEMU's compiled-in bridge helper points to its own nix store path
(~libexec/qemu-bridge-helper~) which is not setuid. The NixOS setuid
wrapper is at ~/run/wrappers/bin/qemu-bridge-helper~. Running QEMU on
a bridge as a regular user requires passing the wrapper path explicitly:

#+begin_src bash
qemu-system-x86_64 \
  -netdev bridge,id=net0,br=br0,helper=/run/wrappers/bin/qemu-bridge-helper \
  -device virtio-net-pci,netdev=net0 \
  ...
#+end_src

*** QEMU hints with ~-nographic~

- ~Ctrl-a x~ — kill QEMU immediately
- ~Ctrl-a c~ — toggle QEMU monitor console (inspect devices, snapshots,
  ~boot_set~, ~system_reset~, ~info~ commands)
- ~Ctrl-a h~ — show all escape shortcuts
- Boot device: ~-boot d~ = CD-ROM, ~-boot c~ = disk (default). After
  installing, drop the ~-cdrom~ flag or switch to ~-boot c~.
- Serial console: NixOS installed systems don't output to serial by
  default. Add ~boot.kernelParams = [ "console=ttyS0,115200" ];~ to
  get console output with ~-nographic~.

*** UEFI boot required

The disko config uses GPT + ESP (type EF00) with systemd-boot. QEMU
defaults to SeaBIOS (BIOS), which can't boot this. Pass OVMF firmware:

#+begin_src bash
qemu-system-x86_64 \
  -bios /path/to/ovmf/FV/OVMF.fd \
  ...
#+end_src

Install OVMF via ~nix build nixpkgs#OVMF.fd~.

** Learnings and Insights

- Use a static IP outside the DHCP range to avoid lease changes between
  reboots.
- ~nix copy --to ssh://user@host~ may fail with "lacks a signature by a trusted
  key". Use ~root@~ instead. ~trusted-users~ would fix this but grants
  root-equivalent nix store access.
- Full ansible flow (re-create-machines + bootstrap) works in QEMU VM
  including kexec.

** Closing Status
