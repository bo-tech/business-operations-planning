* Sprint 2: Testing Foundation for demo-ops

Started: 2026-02-08

** Plan

- [X] Prepare a suitable test host (Linux, KVM)
- [-] Boot ~demo-ops~ dev config in QEMU on the test host, verify SSH works manually
  - [X] Build custom NixOS installer ISO with SSH key
  - [X] Transfer ISO to test host
  - [X] Boot QEMU VM on ~br0~, verify installer gets DHCP address
  - [ ] Adjust ~dev.nix~ k0s API address to match DHCP lease
  - [ ] Run ~nixos-anywhere~ to deploy ~demo-ops#dev~ into the VM
  - [ ] Verify SSH to deployed system works
- [ ] Review existing infrastructure testing tooling (testinfra, labgrid, goss, etc.)
- [ ] Decide where the test code lives (~demo-ops~, separate repo, or ~business-operations~)
- [ ] Set up pytest project skeleton with nix devShell
- [ ] Write QEMU VM lifecycle wrapper (start, wait for SSH, stop)
- [ ] Write first pytest test: boot VM, assert SSH connection works
- [ ] Build NixOS installer ISO with test SSH key baked in
- [ ] Run recreate-machines playbook from pytest against the VM
- [ ] Run bootstrap playbook, assert k0s node is Ready and Cilium is running
- [ ] Document how to trigger test runs from the workstation (SSH to test host)
- [ ] Improve key generation handling in ~demo-ops~ (pulled from backlog)

** Focus

Prove the end-to-end deployment pipeline can be tested automatically
against a QEMU VM.

** Checkpoint

"Can I run a command that deploys ~demo-ops~ into a VM and verifies
Kubernetes is running?"

** Notes

*** QEMU bridge helper for regular users

QEMU's compiled-in bridge helper points to its own nix store path
(~libexec/qemu-bridge-helper~) which is not setuid. The NixOS setuid
wrapper is at ~/run/wrappers/bin/qemu-bridge-helper~. Running QEMU on
a bridge as a regular user requires passing the wrapper path explicitly:

#+begin_src bash
qemu-system-x86_64 \
  -netdev bridge,id=net0,br=br0,helper=/run/wrappers/bin/qemu-bridge-helper \
  -device virtio-net-pci,netdev=net0 \
  ...
#+end_src

** Learnings and Insights

** Closing Status
